# ModSecurity @validateSchema Operator Guide

## Overview

The `@validateSchema` operator in ModSecurity is a powerful tool for validating XML and JSON data against formal schemas. This document focuses on XML schema validation, providing comprehensive information on how to implement and configure this security feature.

## How @validateSchema Works

The `@validateSchema` operator validates incoming XML content against an XSD (XML Schema Definition) file. It returns `true` when validation fails (meaning the input doesn't conform to the expected schema or syntax), allowing rules to trigger defensive actions.

Key features:
- Validates the DOM tree generated by the XML request body processor
- Executes during phase 2 (request body processing)
- Requires explicit XML processing to be enabled
- Provides comprehensive structure, type, and constraint validation

## Configuration Requirements

### 1. Enable XML Body Processing

Before schema validation can occur, ModSecurity must parse the incoming request as XML:

```apache
# Enable XML processing for XML content types
SecRule REQUEST_HEADERS:Content-Type "(?:application/xml|text/xml)" \
  "id:1000,phase:1,pass,t:lowercase,ctl:requestBodyProcessor=XML"
```

### 2. Schema Validation Rule

The basic syntax for XML schema validation:

```apache
SecRule REQUEST_BODY "@validateSchema /path/to/schema.xsd" \
  "id:1001,phase:2,deny,status:400,log,msg:'XML schema validation failed'"
```

### 3. Error Handling

It's crucial to handle XML parsing errors to prevent bypass attacks:

```apache
SecRule REQBODY_PROCESSOR_ERROR "!@eq 0" \
  "id:1002,phase:2,deny,status:400,log,msg:'XML parsing error: %{REQBODY_PROCESSOR_ERROR_MSG}'"
```

## XML Schema Validation Examples

### Example 1: Basic SOAP API Validation

```apache
# Enable XML processing for SOAP requests
SecRule REQUEST_HEADERS:Content-Type "(?:application/soap\+xml|text/xml)" \
  "id:2000,phase:1,pass,t:lowercase,ctl:requestBodyProcessor=XML"

# Validate against SOAP envelope schema
SecRule REQUEST_BODY "@validateSchema /opt/modsecurity/schemas/soap-envelope.xsd" \
  "id:2001,phase:2,deny,status:400,log,auditlog,msg:'Invalid SOAP structure'"

# Handle XML parsing errors
SecRule REQBODY_PROCESSOR_ERROR "!@eq 0" \
  "id:2002,phase:2,deny,status:400,log,msg:'XML processing error: %{REQBODY_PROCESSOR_ERROR_MSG}'"
```

### Example 2: XML Schema with Required Elements

Example XSD schema (`user-schema.xsd`):

```xml
<?xml version="1.0" encoding="UTF-8"?>
<xs:schema xmlns:xs="http://www.w3.org/2001/XMLSchema">
  <xs:element name="user">
    <xs:complexType>
      <xs:sequence>
        <xs:element name="name" type="xs:string" minOccurs="1" maxOccurs="1"/>
        <xs:element name="email" type="xs:string" minOccurs="1" maxOccurs="1"/>
        <xs:element name="age" type="xs:positiveInteger" minOccurs="1" maxOccurs="1"/>
        <xs:element name="role" minOccurs="0" maxOccurs="unbounded">
          <xs:simpleType>
            <xs:restriction base="xs:string">
              <xs:enumeration value="admin"/>
              <xs:enumeration value="user"/>
              <xs:enumeration value="guest"/>
            </xs:restriction>
          </xs:simpleType>
        </xs:element>
      </xs:sequence>
      <xs:attribute name="id" type="xs:ID" use="required"/>
    </xs:complexType>
  </xs:element>
</xs:schema>
```

ModSecurity rule to validate against this schema:

```apache
SecRule REQUEST_BODY "@validateSchema /path/to/user-schema.xsd" \
  "id:4000,phase:2,deny,status:400,log,msg:'Invalid user XML format'"
```

This validation will check:
1. That the XML syntax is valid
2. That the root element is "user" with a required "id" attribute
3. That required child elements (name, email, age) exist with correct types
4. That any "role" elements contain only allowed values (admin, user, guest)

## Advanced Use Cases

### Chaining with Other Security Checks

```apache
SecRule REQUEST_BODY "@validateSchema /schemas/user-schema.xsd" \
  "chain,id:5000,phase:2,deny,status:400,log,msg:'User validation failed'"
SecRule XML:/User/Email "@validateEmail"
```

XML schema validation can form the foundation of a positive security model:

```apache
# Default deny
SecDefaultAction "phase:2,deny,status:400,log,auditlog"

# Enable XML processing
SecRule REQUEST_HEADERS:Content-Type "application/xml" \
  "id:6000,phase:1,pass,t:lowercase,ctl:requestBodyProcessor=XML"

# Block on XML parsing errors
SecRule REQBODY_PROCESSOR_ERROR "!@eq 0" \
  "id:6001,phase:2,log,msg:'XML processing error'"

# Allow only if schema validates (note 'chain' with '@eq false')
SecRule REQUEST_BODY "@validateSchema /schemas/api-schema.xsd" \
  "chain,id:6002,phase:2"
SecRule &TX:blocked "@eq 0" "pass"

# All other requests denied by default
```

## Performance Considerations

- Schema validation is resource-intensive
- The operator uses lazy initialization to avoid schema processing at startup
- Parsed schemas are cached after first use to improve performance
- Consider pre-loading schemas at server startup if possible
- Test validation performance with production-like traffic patterns

## Implementation Details

The implementation uses established XML validation libraries:
- Based on libxml2 for XSD validation (via github.com/terminalstatic/go-xsd-validate)
- Performs full XSD validation of element structure, types, and constraints
- Supports complex schema features including imports, includes, and references

## Security Benefits

XML schema validation provides several security benefits:
- Prevents XML parameter tampering
- Mitigates XDoS (XML Denial of Service) attacks
- Blocks malformed XML exploitation
- Enforces proper data structure and typing
- Rejects unexpected content structures
- Reduces attack surface by validating before business logic processing

## Troubleshooting

Common issues and solutions:

1. **Rule not triggering**: Ensure XML body processor is enabled in phase 1
2. **False positives**: Validate schema against known-good requests
4. **Schema not found**: Verify file paths and permissions

Debugging techniques:

```apache
# Log validation attempts without blocking
SecRule REQUEST_BODY "@validateSchema /path/to/schema.xsd" \
  "id:7000,phase:2,pass,log,auditlog,msg:'Schema validation result'"

# Detailed debug logging
SecDebugLog /var/log/modsec_debug.log
SecDebugLogLevel 9
```

## Conclusion

The `@validateSchema` operator provides robust XML validation capabilities in ModSecurity, enabling comprehensive structural and content validation against formal XML schema definitions. When properly implemented with appropriate error handling, it forms a powerful defense against XML-based attacks and malformed data.
